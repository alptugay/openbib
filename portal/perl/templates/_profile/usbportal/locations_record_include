<table class="ZMSTable" >
<caption align="top"></caption>
<colgroup>
  <col width="16%">
  <col width="83%">
</colgroup>
<tbody>
[%-

PROCESS common/subtemplate name="visible_categories_location";

thisdbname = config.get_databases_of_isil(locationinfo.identifier).first;

sigel = locationinfo.identifier.replace('DE-38-','');

IF sigel == '123';
  recent_litlists1 = user.get_recent_litlists({database = 'inst123', view = view});
  recent_litlists2 = user.get_recent_litlists({database = 'inst218', view = view});
  recent_litlists = recent_litlists1.merge(recent_litlists2);
ELSE ;
  recent_litlists = user.get_recent_litlists({database = thisdbname, view = view});
END;

litlist_content = [];

IF recent_litlists.size > 0;
  litlist_content.push("<ul>");
  FOREACH litlist IN recent_litlists;
    lecturestring = "" ;
    IF litlist.lecture ;
       lectureinfo   = "Offizielle Literaturliste des Instituts/Seminars";
       lecturestring = "&nbsp;<img src=\"http://search.ub.uni-koeln.de${config.get('university_img')}\" title=\"${lectureinfo}\" alt=\"${lectureinfo}\" style=\"vertical-align:bottom\" />";
    ELSE ;
       lectureinfo   = "Ã–ffentliche Literaturliste von Nutzern";
       lecturestring = "&nbsp;<img src=\"http://search.ub.uni-koeln.de${config.get('persons_img')}\" title=\"${lectureinfo}\" alt=\"${lectureinfo}\" style=\"vertical-align:bottom\" />";
    END ;
    litlist_content.push("<li><a target=\"kug\" href=\"http://kug.ub.uni-koeln.de/portal/kug/litlists/id/${litlist.id}.html?l=de\">${litlist.title}</a> (${litlist.itemcount} Titel)${lecturestring}</li>");
  END;
  litlist_content.push("</ul>");
ELSE;
  litlist_content.push("Es wurden noch keine Literaturlisten mit Titel dieses Kataloges angelegt.");
END;

IF sigel == '123';
  recent_tags1 = user.get_recent_tags({database = 'inst123'});
  recent_tags2 = user.get_recent_tags({database = 'inst218'});
  recent_tags = recent_tags1.merge(recent_tags2);
ELSE ;
  recent_tags = user.get_recent_tags({database = thisdbname});
END;

tags_content = [];

IF recent_tags.size > 0;
  tags_content.push("<ul>");
  FOREACH tag IN recent_tags;
    IF tag.tag ;
      tags_content.push("<li><a target=\"kug\" href=\"http://kug.ub.uni-koeln.de/portal/kug/tags/names/id/${tag.tag}.html?l=de\">${tag.tag}</a></li>");
    END ;
  END;
  tags_content.push("</ul>");
ELSE;
  tags_content.push("F&uuml;r Titel in diesem Katalog wurden noch keine Tags vergeben");
END;

no_journals = {
                 '009' = 1
                 '112' = 1
                 '124' = 1
                 '155' = 1
                 '158' = 1
                 '159' = 1
                 '227' = 1
                 '235' = 1
                 '236' = 1
                 '302' = 1
                 '317' = 1
                 '326' = 1
                 '460' = 1
                 '462' = 1
                 '463' = 1
                 '464' = 1
                 '466' = 1
                 '467' = 1
              };

IF NOT no_journals.exists("${sigel}") ;
   locationinfo.fields.${"Zeitschriften"} = [ { content = "Zeitschriftenliste dieser Bibliothek als <a href=\"http://unikatalog.ub.uni-koeln.de/zeitschriftenlisten/zeitschriften-${sigel}-all.pdf\">e-Book</a>" } ];
END ;

IF sigel != 'ARTES' ;
  locationinfo.fields.${"Die zuletzt angelegten Literaturlisten"} = [ { content = litlist_content.join("\n") } ];
  locationinfo.fields.${"Die zuletzt vergebenen Tags"} = [ { content = tags_content.join("\n") } ];
END;

trclass = "even" ;


FOREACH category IN categories;
    IF category == 'Bestand';
       contentarray = [];
       IF locationinfo.fields.${"L0120"}.first.content ;
          thiscontent = locationinfo.fields.${"L0120"}.first.content;
          contentarray.push("Monographien: ${thiscontent}");
       END;
       IF locationinfo.fields.${"L0130"}.first.content ;
          thiscontent = locationinfo.fields.${"L0130"}.first.content;
          contentarray.push("Zeitschriften: ${thiscontent}");
       END;
       IF locationinfo.fields.${"L0140"}.first.content ;
          thiscontent = locationinfo.fields.${"L0140"}.first.content;
          contentarray.push("Lfd. Zeitschriften: ${thiscontent}");
       END;
       IF contentarray.size > 0;
          content = contentarray.join(" / ");
          locationinfo.fields.${"Bestand"} = [ { content = content } ];
       ELSE ;
         NEXT;
       END;
    END;

    IF locationinfo.fields.${category} ;
      FOREACH item IN locationinfo.fields.$category;
        content  = item.content;
        mult     = item.mult;
        subfield = item.subfield;


        # Nachgeschaltete datenbankspezifische Kategorienamen-Mappings sind
        # in Config.pm fuer die entsprechende Datenbank definiert
        # und werden im Message-Katalog als <Kategorie>-<Datenbankname>
        # kodiert.
        thiscategory = category ;
        IF config.get('categorymapping').${locationinfo.databaseinfos.dbname}.$category ;
          thiscategory = "${category}-${record.database}" ;
        END;
-%]
<tr class="[% trclass %]"><td><p>[% msg.maketext("${thiscategory}") %]</p></td><td><p>[% content %]</p></td></tr>
[%-   END ;
      IF trclass == "even" ;
        trclass = "odd";
      ELSE;
        trclass = "even";
      END;
   END ;
END ;-%]
</tbody>
</table>

<p style="font-size:0.8em;">
<b>Hinweis:</b> Diese Informationen beruhen auf Selbstangaben der
Campusbibliotheken und entsprechen dem uns jeweils zuletzt mitgeteilten
Stand. Bitte wenden Sie sich bei etwaigen Unstimmigkeiten direkt an
die jeweilige Bibliothek.
</p>

[%- IF locationinfo.fields.${"L0280"}.first.content -%]
<p>
<div id="map_canvas" style="width: 100%; height: 600px"></div>
</p>

<script src="https://openlayers.org/en/v4.0.1/build/ol.js"></script>

<script type="text/javascript">
      var place = new ol.Feature({
        name: '[% locationinfo.description.replace('"','\'') %]',
        geometry: new ol.geom.Point(ol.proj.fromLonLat([[% locationinfo.fields.${"L0280"}.first.content.split(',').reverse.join(',') %]]))
      });

      place.setStyle(new ol.style.Style({
        image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
          anchor: [0.5, 46],
          anchorXUnits: 'fraction',
          anchorYUnits: 'pixels',
          src: 'https://kug.ub.uni-koeln.de/images/openbib/blue-marker.png'
        }))
      }));

      var vectorSource = new ol.source.Vector({
        features: [place]
      });

      var vectorLayer = new ol.layer.Vector({
        source: vectorSource
      });

      var rasterLayer = new ol.layer.Tile({
        source: new ol.source.OSM()
      });

      var map = new ol.Map({
        layers: [rasterLayer, vectorLayer],
        target: document.getElementById('map_canvas'),
        view: new ol.View({
          center: ol.proj.fromLonLat([[% locationinfo.fields.${"L0280"}.first.content.split(',').reverse.join(',') %]]),
          zoom: 16
        })
      });

</script>
[% END %]
